---
title: "Proyecto Final-Temperaturas"
author: "Luraghi-Rodriguez"
date: "June 18, 2018"
output: pdf_document
---

###BORRADOR

## INTRODUCCION

OBJETIVO:

Relaizar un análisis exploratorio de los datos utilizados para un proyecto cuyo objetivo general es la modelización y predicción de las temperaturas mínimas extremas en Uruguay, utilizando el enfoque
de la teoría de valores extremos.

La modelización de los eventos extremos climáticos resulta de particular interés en la actualidad, debido
al gran impacto que estos fenómenos producen tanto en la población como en los sectores productivos.
Estos últimos, que resultan especialmente sensibles a la variabilidad climática, adolecen en general de
un conocimiento confiable sobre la ocurrencia de sucesos extremos y les es imprescindible asignarles
ciertas probabilidades de ocurrencia. 

Uno de los objetivos específicos del proyecto sobre valores extremos consiste en comparar dos metodologías para la modelización, obteniendo predicciones de los niveles de retorno mediante el Método de Valores Extremos
por Bloques y el Método del Umbral. Además, se busca contrastar los resultados obtenidos mediante el
uso de los diversos paquetes del software estadístico R actualmente disponibles, por lo tanto realizaremos también la exploración de las bases de datos de valores extremos utilizadas para cada uno de los dos métodos mencionados.



## DATOS
La base de datos original está compuesta por registros diarios de temperaturas mínimas
de 26 estaciones meteorológicas de Uruguay para el período 2002-2014. Los datos están comprendidos
entre el 1o de enero de 2002 y el 31 de diciembre de 2014, lo cual implica un total de 4.526
observaciones por estación (118664 observaciones en total). 

La base incluye las siguientes variables:


* nroEstacion: Número de Estación
* lon: longitud en la cual se encuentra ubicada la Estación
* lat: Latitud en la cual se encuentra ubicada la Estación
* altitud: altura de la estación respecto al nivel del mar 
* anio: Año en el cual se registró la temperatura
* mes: Mes en el cual se registró la temperatura
* dia: Día en el cual se registró la temperatura
* tmin: valor en grados celsius de la temperatura mínima del día.
* modis1: Temperatura registrada por satélite
* modis2: Temperatura registrada por satélite 

Sin embargo para la realización del proyecto las variables a utilizar son: 
* número de estacion
* fecha: para tener un orden cronológico, creamos esta nueva variable a partir de las variables año, mes y día
* temperatura mínima registrada 
* coordenadas geograficas para un análisis espacial.
* departamento: asignada de acuerdo a la ubicación geográfica (latitud, longitud) de cada estación.




##ANALISIS EXPLORATORIO DE DATOS


Para la aplicación de métodos de teroría de extremos los datos no pueden ser estacionales ni dependientes(), por lo cual en primera instancia se corrobora con un gráfico de la serie.



```{r, warning=FALSE, echo=FALSE,message=FALSE}
library(ggplot2)
library(ggvis)
library(tidyverse)
library(lubridate)
library(raster)
library(rgeos)
library(rgdal)
library(tseries)
library(xtable)
library(forecast)
library(dplyr)
```


```{r, warning=FALSE, echo=FALSE}
temperaturas <- read.csv("temperaturas.csv", sep = "\t")
temperaturas <- mutate(temperaturas, fecha = paste(dia, mes, 
  anio, sep = "-"))
temperaturas <- mutate(temperaturas, fecha = dmy(temperaturas$fecha))

temperaturas <- mutate(temperaturas, Estacion = as.factor(temperaturas$nroEstacion))

serie <- temperaturas  %>% ggplot(aes(fecha,tmin))+geom_point()
serie

```



Graficamos los registros de temperatura de las 26 estaciones para observar el comportamiento de los datos, como es esperado se observa una gran presencia de estacionalidad. Claramente en cada invierno se observa una caida en las temperaturas y en verano están los picos. Se observa una media constante.



observemos una estación en particular:


```{r, echo=FALSE}
temperaturas <- read.csv("temperaturas.csv", sep = "\t")
temperaturas <- mutate(temperaturas, fecha=paste("01",mes,anio, sep="-"))
temperaturas <- mutate(temperaturas,fecha=dmy(fecha))

temperaturas <- mutate(temperaturas, Estacion = as.factor(temperaturas$nroEstacion))


temperaturas <-filter(temperaturas,Estacion==2) %>% group_by(anio,mes) %>%  slice(which.min(tmin)) %>% filter(anio>2003)

temperaturas_ts <- ts(temperaturas$tmin, start=c(2004, 1), end=c(2014, 12), frequency=12)


ggseasonplot(temperaturas_ts, season.labels = c("Ene","Feb", "Mar","Abr","May","Jun","Jul","Ago","Set","Oct","Nov","Dic")) + labs(title="Temperaturas mínimas por año") + xlab("Mes") + ylab("temperatura mínima")


```

agregar como comentario de figura:

Podemos observar que para todos los años se da el mismo comportamiento, lo que confirma la existencia de estacionalidad, no se observa una tendencia, es decir que al pasar de los años haya un corrimiento de las funciones.

Más adelante veremos métodos que nos ayudan a elegir datos de manera que no exista esta estacionalidad.


Como el objetivo es modelar temperaturas extremas, y dentro de éstas los mínimos, nos enfocaremos en los meses de invierno.

veremos si tenemos outliers entre los meses de mayo y setiembre



```{r,warning=FALSE,echo=FALSE}

temperaturas <- read.csv("temperaturas.csv", sep = "\t")
temperaturas <- mutate(temperaturas, fecha=paste(dia,mes,anio, sep="-"))
temperaturas <- mutate(temperaturas,fecha=dmy(fecha))

temperaturas <- mutate(temperaturas, Estacion = as.factor(temperaturas$nroEstacion)) %>% filter(mes %in% c(5,6,7,8,9) )

ggplot(temperaturas,aes(x=fct_reorder(Estacion,tmin),tmin))+geom_boxplot()+labs(x="Numero de estación", y="temperatura mínima")

# ordenar los boxplots no me ayuda a nada.


```
En el boxplot observamos que tenemos outliers en varias estaciones, pero como lo que nos interesa es estudiar las temperaturas mínimas sólo miraremos a las estaciones 7,13,
14, la cual presenta outliers en los mínimos.



Vemos para las estaciones 7, 13, 14 los valores de los autliers y en que fecha se dan:



```{r,warning=FALSE, echo=FALSE,results='asis'}

temperaturas <- read.csv("temperaturas.csv", sep = "\t")
temperaturas <- mutate(temperaturas, fecha=paste(dia,mes,anio, sep="-"))
temperaturas <- mutate(temperaturas,fecha=dmy(fecha))

estac <-filter(temperaturas,nroEstacion %in% c(7,13,14)) %>% filter(mes %in% c(5,6,7,8,9)) %>% filter(!is.na(tmin)) 
df2 <- subset(estac, select = c(nroEstacion,tmin,fecha))
df2 <- mutate(df2,fecha=as.character(fecha))
options(xtable.comment = FALSE)

group_by(df2,nroEstacion) %>% top_n(-3,tmin) %>% xtable() 


```


Dado estos datos, buscamos para cada dìa una estaciòn cercana y comparamos los valores de temperatura para esos dias.


Utilizando las coordenadas geogràficas asignaremos un departamento a cada estaciòn.


```{r,echo=FALSE}
temperaturas <- read.csv("temperaturas.csv", sep = "\t")
temperaturas <- mutate(temperaturas, fecha=paste(dia,mes,anio, sep="-"))
temperaturas <- mutate(temperaturas,fecha=dmy(fecha))

temperaturas <- mutate(temperaturas, departamento = ifelse(nroEstacion %in% 
  c(1, 2, 25), "Canelones", ifelse(nroEstacion %in% c(13), 
  "Montevideo", ifelse(nroEstacion %in% c(16, 26), "Rocha", 
    ifelse(nroEstacion %in% c(3, 4), "Artigas", ifelse(nroEstacion %in% 
      c(15), "Rivera", ifelse(nroEstacion %in% c(9), "Cerro Largo", 
      ifelse(nroEstacion %in% c(5, 24), "Colonia", ifelse(nroEstacion %in% 
        c(6), "Durazno", ifelse(nroEstacion %in% c(7), 
        "Florida", ifelse(nroEstacion %in% c(8, 14), 
          "Maldonado", ifelse(nroEstacion %in% c(10), 
          "Soriano", ifelse(nroEstacion %in% c(11, 
            19), "Tacuarembó", ifelse(nroEstacion %in% 
            c(12), "Paysandú", ifelse(nroEstacion %in% 
            c(17, 26), "Salto", ifelse(nroEstacion %in% 
            c(18), "San José", ifelse(nroEstacion %in% 
            c(20), "Treinta y Tres", ifelse(nroEstacion %in% 
            c(21), "Flores", "Río Negro"))))))))))))))))))

```


La estaciòn 13, que se encuentra en Montevideo la compararemos con la 18 en San Jose, la 14 con la 8 ya que las dos estàn en Maldonado y la 7 que està en Florida, la compararemos con la 21 que està en Flores.


Comparamos la estacion 13-Montevideo con la 2-Canelones
```{r,echo=FALSE,results='asis'}

 f <- filter(temperaturas,nroEstacion==2) %>% filter(fecha =="2007-08-21"| fecha =="2007-07-29"|fecha =="2009-07-31")
options(xtable.comment = FALSE)
f <- mutate(f,fecha=as.character(fecha))
subset(f, select = c(nroEstacion,tmin,fecha,departamento)) %>% xtable()


```


Comparamos la estacion 14-Maldonado con la 8-Maldonado

```{r,echo=FALSE,results='asis'}

 f <- filter(temperaturas,nroEstacion==8) %>% filter(fecha =="2011-07-08"| fecha =="2013-07-22"|fecha =="2013-08-23")
options(xtable.comment = FALSE)
f <- mutate(f,fecha=as.character(fecha))
subset(f, select = c(nroEstacion,tmin,fecha,departamento)) %>% xtable()


```

comparamos estacion 7-Florida con estacion 6-durazno


```{r,echo=FALSE,results='asis'}

 f <- filter(temperaturas,nroEstacion==6
             ) %>% filter(fecha =="2012-07-30"| fecha =="2012-06-09"|fecha =="2012-07-28")
options(xtable.comment = FALSE)
f <- mutate(f,fecha=as.character(fecha))
subset(f, select = c(nroEstacion,tmin,fecha,departamento)) %>% xtable()


```



2012-06-09 \\ 
  2 &   7 & -10.00 & 2012-07-28 \\ 
  3 &   7 & -6.00 & 2012-07-30 










Tabla de temperaturas mínimas por departamento: para ver si las mínimas se registraron en el mismo año y si hay una correlación de temperaturas y ubicación geografica( sur-centro-norte). Se agrega una variable mas

detallar que departamentos son parte de cada grupo.

hay correlacion entre las temperaturas mínimas y la altitud?


Plot de temperatura mínima registrada en cada año, (puede ser un plotly) coloreado por zona de estación. La idea es explorar si los mínimos siempre se dan en la misma zona o no. si hay una correlación.


Exploración espacial:

Se presentan dos mapas, uno en el cual se ubican las estaciones seleccionadas y otro que muestra las temperaturas mínimas por mes en cada departamento coloreado por las temperaturas.



#Metodologia.

El interés de la Teoría de valores extremos está centrado en modelar el comportamiento de $M_n = max \{X_1,X_2, \ldots, X_n \} $ siendo $X_1,X_2, \ldots , X_n$ una secuencia de variables aleatorias independientes con distribución F, y M_n representa el maximo del proceso sobre n unidades de tiempos de observación. 

En Teoría la distribución de $M_n$ podría calcularse de manera exacta a partir de la función de distribución F: 

$P(M_n \leq z) = P(X_1 \leq z, \ldots , X_n \leq z = P(X_1 \leq z) \times \ldots \times P(X_n \leq z) = [F(z)]^n$
            
Sin embargo, al sustituir F (desconocida) por su estimación y elevar a la n, pueden generarse grandes discrepancias.

Un camino alternativo a este problema, es considerar F desconocida y aproximar directamente la distribución de $F^n$ utilizando un subconjunto de la base, los valores extremos. 

Esta solución, análoga al Teorema Central del Límite, consiste en la busqueda de secuencias constantes $\{b_n; n \geq 1 \}$ y $\{a_n; n \geq 1 \}$ tales que la distribución de $M_n^* = \frac{M_n - b_n}{a_n}$ converge a una distribución no degenerada cuando $n \to + \inf$ .

## Teorema de Valores extremos: 

Si existen sucesiones constantes $a_n > 0$ y $b_n$ tales que: 

$P(M^*_n = \cfrac{M_n - b_n}{a_n} \leq z) = F^n(a_nz + b_n)\to G(z)$ 

entonces G pertenece a una de las siguientes familias: 

#################################################

El Teorema (1.1) afirma que $M^*_n$ converge en distribución a una de las tres familias de distribuciones mencionadas en el teorema las que, en conjunto, se denominan distribuciones de valores extremos (DVE). En particular, $(a)$ es la distribución de Gumbel, $(b)$ es la distribución de Fréchet y $(c)$ es la distribución de Weibull. Cada familia tiene un parámetro de ubicación y escala, $\mu$ y $\sigma$ respectivamente, y un parámetro de forma $\alpha$ en el caso de las familias Fréchet y Weibull. 

Si bien el Teorema (1.1) no garantiza la existencia de un límite no degenerado para $M_n$, ni nos dice cuál es el límite cuando existe, la distribución límite de la variable normalizada $M^*_n$ tiene que ser alguna de las distribuciones incluidas en el teorema, cualquiera sea la distribución poblacional $F$.
\\

Los tres tipos de distribución del teorema pueden ser combinados en una sola distribución con una parametrización común, propuesta por Von Mises (1954) y Jenkinson (1955), que se conoce como la \textbf{Distribución de Valores Extremos Generalizada} (GEV, por sus siglas en inglés). La forma de esta distribución es: 


$G_{\xi,\mu,\sigma}(x) = exp\ \Big\{-\Big(1+\xi \Big(\cfrac{x-\mu}{\sigma}\Big)\Big)_+^{-1/ \xi}\Big\}$





En los siguientes métodos asumiremos que la función F (distribución de los daots) es desconocida, y estimaremos directamente la distribución extrema, para esto intentamos captar en una nueva base aquellos valores extremos sobre los cuales nos interesa trabajar.


Método del umbral: Consiste en seleccionar un valor u llamado umbral, y considerar aquellas observaciones que superen este valor. La elección de un umbral muy bajo aumentará el sesgo del modelo, mientras que la eleccion de un umbral demasiado alto aumentará la varianza.

Método "Block Maxima": Útil cuando los datos pueden ser divididos en m bloques de tamaño m, el método consiste en seleccionar la temperatura extrema por bloque, asumiendo que las observaciones de los máximos por bloque son independientes.
La elección del tamaño del bloque genera un trade-off entre sesgo y varianza, tomar bloques pequeños generan un mayor sesgo mientras que bloques de mayor tamaño aumentan la varianza en la estimacion de los parametros de la distribución.





##Descripción de la aplicación shiny

A través de la aplicación Shiny, mostraremos el análisis exploratorio de los datos, aparecerán gráficos de la serie de temperaturas, pudiendo filtrar por numero de estación, y pudiendo ubicar geograficamente las mismas. Para todo el territorio uruguayo se podrá observar por mes las temperaturas mínimas registradas en cada departamento.









##Comentarios finales




## Referencias

-coles
-R
-librerias
